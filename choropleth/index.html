<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Choropleth Map with D3</title>
    <!-- styles and font -->
    <link rel="stylesheet" type="text/css" href="../index.css" />
    <link href="https://fonts.googleapis.com/css?family=Dosis&display=swap" rel="stylesheet" />
</head>

<body>
    <nav><ul></ul></nav>
    <main class="mainContent">
        <h1 id="title">United States Educational Attainment</h1>
        <h4 id="description">Percentage of adults age 25 and older with a bachelor's degree or higher, 2010-2014</h4>
    </main>
    <footer><ul></ul></footer>

    <!-- D3 lib and topojson -->
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>
    <!-- project code -->
    <script>
        const w = 480;
        const h = 305;
        const eduDataURL="https://cdn.freecodecamp.org/testable-projects-fcc/data/choropleth_map/for_user_education.json";
        const countyDataURL="https://cdn.freecodecamp.org/testable-projects-fcc/data/choropleth_map/counties.json";

        async function getData(eduURL, cntURL){
            try {
                const eduData = await fetch(eduURL).then(d => d.json());
                const topoData = await fetch(cntURL).then(d => d.json());

                const maxPercent = d3.max(eduData, d => d.bachelorsOrHigher);
                //const whoAreYou = eduData.filter(d => d.bachelorsOrHigher > 70); //VA tho
                const deltaLightness = 100/maxPercent;

                const scaleArea = (scaleFactor) => {
                    return d3.geoTransform({
                        point: function(x,y) {
                            this.stream.point(x*scaleFactor, y*scaleFactor);
                        }
                    });
                }
                const path = d3.geoPath().projection(scaleArea(0.5));

                const setColor = (percent)=> {
                    return `hsl(0,50%,${100 - deltaLightness*percent}%)`;
                }

                const svg = d3.select('.mainContent')
                    .append('svg')
                    .attr('width', w)
                    .attr('height', h);

                    svg.append('g')
                        .attr('class', 'counties')
                        .selectAll('path')
                        .data(topojson.feature(topoData, topoData.objects.counties).features)
                        .enter()
                        .append('path')
                        .attr('class', 'county')
                        .attr('data-fips', (d => d.id))
                        .attr('data-education',  d => {
                            let join = eduData.filter(obj => obj.fips === d.id);
                            return join[0] ? join[0].bachelorsOrHigher : 'no data';
                        })
                        .attr('fill', d => {  
                            let join = eduData.filter(obj => obj.fips === d.id);
                            //return 'hsl(0,50%,50%)'
                            return join[0] ? setColor(join[0].bachelorsOrHigher) : 'hsl(0, 100%, 100%)';
                        })
                        .attr('d', path); 

                        /* svg
                        .append('path')
                        .datum(topojson.mesh(topoData, topoData.objects.states, (a, b) => a !== b))
                        .attr('class', 'states')
                        .attr('d', path);*/
            }
            catch(e){console.log(e)}
        }

        getData(eduDataURL, countyDataURL);
    </script>
</body>
</html>